---
- name: Install Solarized plugin
  git: >
    repo=git://github.com/altercation/vim-colors-solarized.git 
    dest=~/.vim/bundle/vim-colors-solarized
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install Nerdtree plugin
  git: 
    repo=https://github.com/scrooloose/nerdtree.git
    dest=~/.vim/bundle/nerdtree
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users


- name: Install AutoComplPop plugin
  git: 
    repo=https://github.com/vim-scripts/AutoComplPop.git
    dest=~/.vim/bundle/AutoComplPop
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install vim-fugitive plugin
  git:
    repo=https://github.com/tpope/vim-fugitive.git
    dest=~/.vim/bundle/vim-fugitive
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

#- name: Install CtrlP
#  git:
#    repo=https://github.com/kien/ctrlp.vim.git
#    dest=~/.vim/bundle/ctrlp.vim
#    update=yes
#    accept_hostkey=yes
#  become: true
#  become_user: "{{vim_user}}"

- name: Install rainbow_parentheses plugin
  git:
    repo=https://github.com/kien/rainbow_parentheses.vim.git
    dest=~/.vim/bundle/rainbow_parentheses
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install syntastic plugin
  git:
    repo=https://github.com/scrooloose/syntastic.git
    dest=~/.vim/bundle/syntastic
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users


- name: Install tabular plugin
  git:
    repo=https://github.com/godlygeek/tabular.git
    dest=~/.vim/bundle/tabular
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install vim-bundler plugin
  git:
    repo=https://github.com/tpope/vim-bundler.git
    dest=~/.vim/bundle/vim-bundler
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install vim-javascript plugin
  git:
    repo=https://github.com/pangloss/vim-javascript.git
    dest=~/.vim/bundle/vim-javascript
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install vim-puppet plugin
  git:
    repo=https://github.com/rodjek/vim-puppet.git
    dest=~/.vim/bundle/vim-puppet
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install vim-rails plugin
  git:
    repo=https://github.com/tpope/vim-rails.git
    dest=~/.vim/bundle/vim-rails
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install vim-sensible plugin
  git:
    repo=https://github.com/tpope/vim-sensible.git
    dest=~/.vim/bundle/vim-sensible
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Install YouCompleteMe dependencies
  apt: 
    name="{{item}}"
    state=present
  with_items:
    - python-dev
    - build-essential
    - cmake

#- name: Remove YouCompleteMe git for plugin
#  file: path=~/.vim/bundle/YouCompleteMe state=absent
#  become: true
#  become_user: "{{item}}"
#  with_items: users

- name: Detect previous YouCompleteMe revision
  register: youcompleteme_revision_old
  shell: >
    if [ -d ~/.vim/bundle/YouCompleteMe ]; then 
      cd ~/.vim/bundle/YouCompleteMe ; 
      git rev-parse HEAD ;
    fi
  ignore_errors: false

- name: Fetch YouCompleteMe plugin
  git:
    repo=https://github.com/Valloric/YouCompleteMe.git
    dest=~/.vim/bundle/YouCompleteMe
    update=yes
    accept_hostkey=yes
  become: true
  become_user: "{{item}}"
  with_items: users

- name: Detect new YouCompleteMe revision
  register: youcompleteme_revision_new
  shell: >
    if [ -d ~/.vim/bundle/YouCompleteMe ]; then 
      cd ~/.vim/bundle/YouCompleteMe ; 
      git rev-parse HEAD ;
    fi
  ignore_errors: false

- name: Detect YouCompleteMe built plugin
  debug:  msg="old={{youcompleteme_revision_old}} new={{youcompleteme_revision_new}}"

- name: Detect YouCompleteMe built plugin
  register: youcompleteme_exists
  command: test -f ~/.vim/bundle/YouCompleteMe/third_party/ycmd/ycm_core.so
  ignore_errors: true


- name: Build YouCompleteMe plugin
  shell: cd ~/.vim/bundle/YouCompleteMe ; ./install.sh
  become: true
  become_user: "{{item}}"
  with_items: users
  when: youcompleteme_exists|failed

